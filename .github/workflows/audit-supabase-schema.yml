name: Audit Supabase Schema

# Manual workflow to dump the production database schema
# This helps audit the current state of the production database
# and identify any manual changes that need to be captured in migrations

on:
  workflow_dispatch:

jobs:
  dump-schema:
    runs-on: ubuntu-latest
    
    steps:
      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client
      
      - name: Dump production schema
        env:
          SUPABASE_DB_URL_PROD: ${{ secrets.SUPABASE_DB_URL_PROD }}
        run: |
          # Generate filename with current date
          DATE=$(date +%Y%m%d-%H%M%S)
          FILENAME="supabase-schema-${DATE}.sql"
          
          # Dump schema only (no data, no owner, no privileges)
          pg_dump "${SUPABASE_DB_URL_PROD}" \
            --schema-only \
            --no-owner \
            --no-privileges \
            --file="${FILENAME}"
          
          echo "Schema dumped to ${FILENAME}"
          ls -lh "${FILENAME}"
      
      - name: Upload schema artifact
        uses: actions/upload-artifact@v4
        with:
          name: supabase-schema-${{ github.run_number }}
          path: supabase-schema-*.sql
          retention-days: 90
